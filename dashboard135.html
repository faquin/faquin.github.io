<!DOCTYPE HTML>

 <html>
<head>
	<title>Particle Login Example</title>
</head>
<body onload="loading()">
	<script src="https://cdn.jsdelivr.net/npm/particle-api-js@8/dist/particle.min.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js" type="text/javascript" charset="utf-8"></script>
	<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z" crossorigin="anonymous">
	<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js" integrity="sha384-B4gt1jrGC7Jh4AgTPSdUtOBvfO8shuf57BaghqFfPlYxofvL8/KUEfYiJOMMV+rV" crossorigin="anonymous"></script>
	<script>
		
		//Get you accesstoken from LocalStorage if you've logged in before.
		var token = localStorage.getItem("token");
		var particle = new Particle();
		var logged_in=false;
		
		function loading(){
			if(token){	// on a déjà un token
				document.getElementById('login-window').style.display="none";	// on cache la fenetre de login
				document.getElementById("BoutonLogin").innerHTML = "Logout";
				ListDevices();
			}
		}
		
		//Delete accesstoken from LocalStorage, and reload page.
		function logout() {
			localStorage.removeItem("token");
			var logged_in=false;
			window.location.reload();
		}
		
		function login() {
		 
		 if(!token){	//si pas encore de token
			var login=document.getElementById('InputLogin').value;
			var pass=document.getElementById('InputPassword').value;
			
			particle.login({username: login, password: pass}).then(
			  function(data) {
				token=data.body.access_token;
				localStorage.setItem("token",token);
				console.log(token);
				ListDevices();
			  },
			  function (err) {
				console.log('Could not log in.', err);
			  }
			);
		
			var logged_in=true;
			document.getElementById('login-window').style.display="none";
			document.getElementById("BoutonLogin").innerHTML = "Logout";
			
			}
			else{
				logout();
			}

		}
		
		function ListDevices(){
			particle.listDevices({ auth: token }).then(
				function(data){
					//console.log(data);
					for(var ii = 0; ii < data.body.length; ii++) {
						var dev = data.body[ii];
						//console.log("dev ii=" + ii, dev);
						
						// The entries that come back have the following things in dev:
						// cellular: false
						// connected: true
						// id: "<yourdeviceid>"
						// last_app: null
						// last_heard: "2016-03-18T18:11:36.183Z"
						// last_ip_address: "<youripaddress>"
						// name: "test4"
						// platform_id: 6
						// product_id: 6
						// status: "normal"
						
						if (dev.connected) {
							console.log(dev.name, dev.id, "is connected");
							console.log(dev);
							var newHTML="<div class=\"card text-white bg-info mb-3\"><div class=\"card-body\"> <h5 class=\"card-title\">"+dev.name+"</h5>";
							
							// variables
							if(Object.keys(dev.variables).length>0){
								newHTML += "<div class=\"container\">";
								for(i=0; i<Object.keys(dev.variables).length; i++){
									newHTML += "<div class=\"row\"><div class=\"col-sm\">"+Object.keys(dev.variables)[i]+"</div>";
									//newHTML += "<div class=\"col-sm\">VALEUR</div>";
									newHTML += "</div>";
								}
								newHTML += "</div>";	// fin du container de la ligne
							}
							
							
							// fonctions
							newHTML += "<div class=\"container\">";
							for(i=0; i<dev.functions.length; i++){
									newHTML += "<div class=\"row\"><div class=\"col-sm\"><button type=\"button\" class=\"btn btn-primary\">"+dev.functions[i]+"()</button></div>";
									//newHTML += "<div class=\"col-sm\">VALEUR</div>";
									newHTML += "</div>";
								}
								newHTML += "</div>";	// fin du container de la ligne
							
							newHTML += "</div> </div>";

							$("div.card-deck").append(newHTML);
						}
					}
				},
				function(err){
					console.log('Could not get devices.', err);
				}
			);
		}
	

		
		
		
		
		
		function Chauffage(CmdChauffage) {
			var fnPr = particle.callFunction({ deviceId: '270043000447343232363230', name: 'TestChauff', argument: toString(CmdChauffage), auth: token });

			fnPr.then(
			  function(data) {
				console.log('Chauffage=', data);
			  }, function(err) {
				console.log('Chauffage pas changé:', err);
			  });
			//var requestURL1 = "https://api.particle.io/v1/devices/" +deviceID + "/TestChauff/";
			//$.post( requestURL1, { params: CmdChauffage, token: accessToken});
		}

	</script>	
	
	<form id="login-window">
	  <div class="w-25 form-group p-3">
		<label for="InputLogin">Login</label>
		<input type="login" class="form-control" id="InputLogin" aria-describedby="InputLogin" placeholder="login" value="fabien.goy@gmail.com">
		<label for="InputPassword">Password</label>
		<input type="password" class="form-control" id="InputPassword" placeholder="Password" value="9hL3lDaVy9lU">
	  </div>
	</form>
	<button type="submit" id="BoutonLogin" class="btn btn-primary" onclick="login()">Login</button>
	
	<br><br>


	
	<button id="ChauffageON" onclick="Chauffage(1)">AllumerChauffage</button>
	<button id="ChauffageOFF" onclick="Chauffage(0)">EteindreChauffage</button>
	
	
	<div class="card-deck" >
	  <!--<div class="card text-white bg-info mb-3">
		<div class="card-body">
		  <h5 class="card-title">Card title</h5>
		  <p class="card-text">This is a longer card with text</p>
		  <p class="card-text"><small class="text-muted">Last updated 3 mins ago</small></p>
		</div>
	  </div>
	-->
	</div>
	
	
</body>
</html>
